---
title: Gestion des missions
description: Guide complet pour créer, assigner, suivre et compléter des missions dans DispatchKit.
---

import { Tabs, TabItem, Aside } from '@astrojs/starlight/components';

## Gestion des missions

Les missions sont le cœur de DispatchKit. Ce guide couvre l'intégralité du cycle de vie d'une mission, du dashboard web ou de l'API.

## Créer une mission

<Tabs>
  <TabItem label="Dashboard">
    1. Cliquez sur **Nouvelle mission** dans la barre de navigation
    2. Renseignez le formulaire :
       - **Titre** : description opérationnelle courte
       - **Adresse de départ** : point d'origine (avec autocomplétion)
       - **Adresse d'arrivée** : destination finale
       - **Client** : sélectionnez un client existant ou créez-en un nouveau
       - **Date planifiée** : optionnel, pour les missions programmées
    3. Cliquez sur **Créer**

    La mission est créée avec le statut `PENDING`.
  </TabItem>
  <TabItem label="API">
    ```bash
    curl -X POST https://api.dispatchkit.io/api/v1/missions \
      -H "Authorization: Bearer {token}" \
      -H "Content-Type: application/json" \
      -d '{
        "title": "Livraison Rue de la Paix",
        "origin_address": "12 Rue Beaubourg, 75004 Paris",
        "destination_address": "8 Rue de la Paix, 75001 Paris",
        "client_id": "cli_01J5X...",
        "scheduled_at": "2024-01-15T10:00:00Z"
      }'
    ```
  </TabItem>
</Tabs>

## Assigner une mission

L'assignation d'une mission à un opérateur déclenche une notification push sur son téléphone.

<Tabs>
  <TabItem label="Dashboard">
    Depuis la vue mission ou la carte :
    1. Ouvrez la mission au statut `PENDING`
    2. Cliquez sur **Assigner**
    3. Choisissez un opérateur disponible dans la liste (triée par distance)
    4. Confirmez l'assignation

    La mission passe en `ASSIGNED` et l'opérateur est notifié.
  </TabItem>
  <TabItem label="API">
    ```bash
    curl -X POST https://api.dispatchkit.io/api/v1/missions/{id}/assign \
      -H "Authorization: Bearer {token}" \
      -H "Content-Type: application/json" \
      -d '{
        "operator_id": "usr_01J5X..."
      }'
    ```
  </TabItem>
</Tabs>

<Aside type="caution">
  Seuls les opérateurs avec le statut `available` peuvent recevoir une mission. Tenter d'assigner à un opérateur `on_mission` renvoie une erreur `422`.
</Aside>

## Suivi en temps réel

Une fois la mission en `IN_PROGRESS`, vous pouvez suivre l'opérateur via :

- **La carte du dashboard** — position mise à jour toutes les 5 secondes
- **Les événements SSE** — flux temps réel sur `/api/v1/sse/missions/{id}`
- **L'API positions** — historique des positions GPS

### Événements de suivi

| Événement SSE | Déclencheur |
|---------------|-------------|
| `mission.started` | L'opérateur démarre la mission |
| `mission.on_site` | L'opérateur arrive sur place |
| `position.updated` | Nouvelle position GPS reçue |
| `mission.completed` | Mission terminée |

## Compléter une mission

La complétion est effectuée par l'opérateur depuis l'application mobile. Il peut ajouter :

- **Notes** : remarques libres sur l'intervention
- **Photos** : preuves photographiques (jusqu'à 5 photos)
- **Signature** : signature digitale du client sur place

Le dispatcher reçoit une notification et peut consulter le **reçu de complétion** depuis le dashboard.

## Annuler une mission

<Tabs>
  <TabItem label="Dashboard">
    Ouvrez la mission et cliquez sur **Annuler la mission**. Saisissez une raison (obligatoire) et confirmez.
  </TabItem>
  <TabItem label="API">
    ```bash
    curl -X PATCH https://api.dispatchkit.io/api/v1/missions/{id} \
      -H "Authorization: Bearer {token}" \
      -H "Content-Type: application/json" \
      -d '{
        "status": "CANCELLED",
        "cancellation_reason": "Client absent, mission reportée"
      }'
    ```
  </TabItem>
</Tabs>

<Aside type="note">
  Les missions complétées et annulées sont conservées indéfiniment et accessibles dans l'historique. Elles ne peuvent pas être supprimées.
</Aside>

## Workflow des statuts

```
Création ──→ PENDING
                │
         Assignation ──→ ASSIGNED
                              │
                    Démarrage ──→ IN_PROGRESS
                                      │
                             Arrivée ──→ ON_SITE
                                            │
                              ┌─────────────┤
                              ↓             ↓
                          COMPLETED     CANCELLED
```
